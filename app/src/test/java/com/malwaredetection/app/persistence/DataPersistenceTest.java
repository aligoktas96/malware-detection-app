package com.malwaredetection.app.persistence;

import com.malwaredetection.app.TestInitializer;
import com.malwaredetection.app.dto.DetectionDTO;
import com.malwaredetection.app.dto.DetectionSearchCriteria;
import com.malwaredetection.app.dto.DeviceDTO;
import com.malwaredetection.app.enums.DetectionType;
import com.malwaredetection.app.enums.DeviceType;
import com.malwaredetection.app.repository.DetectionRepository;
import com.malwaredetection.app.repository.DeviceRepository;
import com.malwaredetection.app.repository.entity.Detection;
import com.malwaredetection.app.repository.entity.Device;
import com.malwaredetection.app.specification.MalwareDetectionSpecification;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.mockito.InjectMocks;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.jdbc.AutoConfigureTestDatabase;
import org.springframework.boot.test.autoconfigure.orm.jpa.DataJpaTest;
import org.springframework.data.domain.Sort;
import org.springframework.test.context.ContextConfiguration;

import java.time.Instant;
import java.time.temporal.ChronoUnit;
import java.util.List;
import java.util.Optional;
import java.util.UUID;

import static org.junit.jupiter.api.Assertions.*;


@DataJpaTest
@ContextConfiguration(initializers = {TestInitializer.class})
@AutoConfigureTestDatabase(replace = AutoConfigureTestDatabase.Replace.NONE)
class DataPersistenceTest {

    @Autowired
    private DetectionRepository detectionRepository;

    @Autowired
    private DeviceRepository deviceRepository;

    @InjectMocks
    private MalwareDetectionSpecification malwareDetectionSpecification;

    private DeviceDTO testDeviceDTO;

    private DetectionDTO testDetectionDTO;

    @BeforeEach
    void setUp() {
        testDeviceDTO = DeviceDTO.builder()
                .deviceUID(UUID.fromString("4419d425-f88d-4c48-adbc-e94a1b7766ef"))
                .deviceType(DeviceType.IOS)
                .build();

        testDetectionDTO = DetectionDTO.builder()
                .detectionID(UUID.fromString("3c4f4d4c-0101-4c4f-8888-010101010101"))
                .type(DetectionType.NEW)
                .nameOfApp("MyApp")
                .build();
    }

    @Test
    void testStoreDetection() {
        Optional<Device> optionalDevice = deviceRepository.findById(testDeviceDTO.getDeviceUID());
        assertTrue(optionalDevice.isPresent());

        Device device = optionalDevice.get();
        assertFalse(device.getDetections().isEmpty());

        Detection detection = device.getDetections().get(0);

        assertEquals(testDetectionDTO.getDetectionID(), detection.getDetectionID());
        assertEquals(testDetectionDTO.getType(), detection.getType());
        assertEquals(testDetectionDTO.getNameOfApp(), detection.getNameOfApp());
    }

    @Test
    void testFindDetectionMessages() {

        List<Detection> detectionList = detectionRepository.
                findAll(malwareDetectionSpecification.build(
                        DetectionSearchCriteria
                                .builder()
                                .deviceUID(testDeviceDTO.getDeviceUID())
                                .deviceType(testDeviceDTO.getDeviceType())
                                .nameOfApp(testDetectionDTO.getNameOfApp())
                                .detectionType(testDetectionDTO.getType())
                                .fromDate(Instant.now().minus(30, ChronoUnit.DAYS))
                                .toDate(Instant.now())
                                .build()
                ), Sort.by(Sort.Direction.DESC, "time"));

        assertEquals(testDetectionDTO.getType(), detectionList.get(0).getType());
        assertEquals(testDetectionDTO.getNameOfApp(), detectionList.get(0).getNameOfApp());
        assertEquals(testDeviceDTO.getDeviceUID(), detectionList.get(0).getDevice().getDeviceUID());
        assertEquals(testDeviceDTO.getDeviceType(), detectionList.get(0).getDevice().getDeviceType());

    }

}

