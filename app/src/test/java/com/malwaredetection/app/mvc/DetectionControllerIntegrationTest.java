package com.malwaredetection.app.mvc;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.malwaredetection.app.controller.DetectionController;
import com.malwaredetection.app.controller.request.MalwareDetectionRequest;
import com.malwaredetection.app.controller.response.DetectionMessageResponse;
import com.malwaredetection.app.dto.DetectionDTO;
import com.malwaredetection.app.dto.DetectionSearchCriteria;
import com.malwaredetection.app.dto.DeviceDTO;
import com.malwaredetection.app.enums.DetectionType;
import com.malwaredetection.app.enums.DeviceType;
import com.malwaredetection.app.service.DetectionService;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.web.servlet.WebMvcTest;
import org.springframework.boot.test.mock.mockito.MockBean;
import org.springframework.http.MediaType;
import org.springframework.test.web.servlet.MockMvc;

import java.time.Instant;
import java.time.temporal.ChronoUnit;
import java.util.Arrays;
import java.util.List;
import java.util.UUID;

import static org.hamcrest.Matchers.hasSize;
import static org.hamcrest.Matchers.is;
import static org.mockito.BDDMockito.given;
import static org.mockito.Mockito.times;
import static org.mockito.Mockito.verify;
import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.get;
import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.post;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.jsonPath;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.status;


@WebMvcTest(DetectionController.class)
class DetectionControllerIntegrationTest {

    @Autowired
    private MockMvc mockMvc;

    @MockBean
    private DetectionService detectionService;

    MalwareDetectionRequest request;

    List<DetectionMessageResponse> detections;

    @BeforeEach
    void setUp() {
        request = MalwareDetectionRequest.builder()
                .device(DeviceDTO.builder()
                        .deviceUID(UUID.randomUUID())
                        .deviceType(DeviceType.ANDROID)
                        .build())
                .detections(Arrays.asList(
                        DetectionDTO.builder()
                                .type(DetectionType.NEW)
                                .nameOfApp("App1")
                                .build(),
                        DetectionDTO.builder()
                                .type(DetectionType.RESOLVED)
                                .nameOfApp("App2")
                                .build()
                ))
                .build();

        detections = Arrays.asList(
                DetectionMessageResponse.builder()
                        .type(DetectionType.NEW)
                        .nameOfApp("App1")
                        .deviceType(DeviceType.ANDROID)
                        .build(),
                DetectionMessageResponse.builder()
                        .type(DetectionType.RESOLVED)
                        .nameOfApp("App2")
                        .deviceType(DeviceType.IOS)
                        .build()
        );
    }

    @Test
    void testStoreDetection() throws Exception {

        mockMvc.perform(post("/detection")
                        .contentType(MediaType.APPLICATION_JSON)
                        .content(new ObjectMapper().writeValueAsString(request)))
                .andExpect(status().isOk());

        verify(detectionService, times(1)).storeDetection(request);
    }

    @Test
    void testListDetectionMessages() throws Exception {
        UUID deviceUID = UUID.randomUUID();
        Instant fromDate = Instant.now().minus(1, ChronoUnit.DAYS);
        Instant toDate = Instant.now();

        DetectionSearchCriteria detectionSearchCriteria = DetectionSearchCriteria.builder()
                .deviceUID(deviceUID)
                .fromDate(fromDate)
                .toDate(toDate)
                .build();

        given(detectionService.findDetectionMessages(detectionSearchCriteria))
                .willReturn(detections);

        mockMvc.perform(get("/detection")
                        .param("deviceUID", deviceUID.toString())
                        .param("fromDate", fromDate.toString())
                        .param("toDate", toDate.toString()))
                .andExpect(status().isOk())
                .andExpect(jsonPath("$", hasSize(2)))
                .andExpect(jsonPath("$[0].nameOfApp", is("App1")))
                .andExpect(jsonPath("$[0].type", is(DetectionType.NEW.name())))
                .andExpect(jsonPath("$[0].deviceType", is(DeviceType.ANDROID.name())))
                .andExpect(jsonPath("$[1].nameOfApp", is("App2")))
                .andExpect(jsonPath("$[1].type", is(DetectionType.RESOLVED.name())))
                .andExpect(jsonPath("$[1].deviceType", is(DeviceType.IOS.name())));
    }

}
