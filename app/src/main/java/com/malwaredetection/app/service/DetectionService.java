package com.malwaredetection.app.service;

import com.malwaredetection.app.controller.request.MalwareDetectionRequest;
import com.malwaredetection.app.controller.response.DetectionMessageResponse;
import com.malwaredetection.app.dto.DetectionDTO;
import com.malwaredetection.app.dto.DetectionSearchCriteria;
import com.malwaredetection.app.dto.DeviceDTO;
import com.malwaredetection.app.enums.DetectionType;
import com.malwaredetection.app.exception.BusinessException;
import com.malwaredetection.app.exception.handler.ApiErrorCode;
import com.malwaredetection.app.mapper.CustomMapper;
import com.malwaredetection.app.repository.DetectionRepository;
import com.malwaredetection.app.repository.DeviceRepository;
import com.malwaredetection.app.repository.entity.Detection;
import com.malwaredetection.app.repository.entity.Device;
import com.malwaredetection.app.specification.MalwareDetectionSpecification;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.data.domain.Sort;
import org.springframework.data.jpa.domain.Specification;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.sql.Timestamp;
import java.time.Instant;
import java.util.List;
import java.util.Optional;
import java.util.UUID;
import java.util.stream.Collectors;

@Slf4j
@Service
@RequiredArgsConstructor
public class DetectionService {

    private final DetectionRepository detectionRepository;

    private final DeviceRepository deviceRepository;

    private final CustomMapper customMapper;

    private final MalwareDetectionSpecification malwareDetectionSpecification;

    @Transactional
    public void storeDetection(MalwareDetectionRequest malwareDetectionRequest) {
        DeviceDTO deviceDTO = malwareDetectionRequest.getDevice();
        List<DetectionDTO> detections = malwareDetectionRequest.getDetections();

        Optional<Device> optionalDevice = deviceRepository.findById(deviceDTO.getDeviceUID());
        Device device = optionalDevice.orElseGet(() -> customMapper.dtoToEntity(deviceDTO));

        processDetections(detections, device);
    }

    public List<DetectionMessageResponse> findDetectionMessages(DetectionSearchCriteria searchCriteria) {
        Specification<Detection> detectionSpecification = malwareDetectionSpecification.build(searchCriteria);
        Sort sorting = Sort.by(Sort.Direction.DESC, "time");

        List<Detection> detections = detectionRepository.findAll(detectionSpecification, sorting);

        if (detections.isEmpty()) {
            throw new BusinessException(ApiErrorCode.DETECTION_NOT_FOUND);
        }

        return detections.stream()
                .map(customMapper::entityToMessageResponse)
                .collect(Collectors.toList());
    }

    private void processDetections(List<DetectionDTO> detections, Device device) {
        for (DetectionDTO detectionDTO : detections) {
            DetectionType detectionType = detectionDTO.getType();

            UUID detectionID = detectionDTO.getDetectionID();
            Optional<Detection> optionalDetection = detectionRepository.findById(detectionID);

            Detection detection;
            if (optionalDetection.isPresent()) {
                detection = optionalDetection.get();
                switch (detectionType) {
                    case RESOLVED:
                        detection.setResolvedDetectionID(detectionDTO.getResolvedDetectionID());
                        detection.setType(detectionDTO.getType());
                        detection.setTime(Timestamp.from(Instant.now()));
                        log.info("Resolved detection with ID: {}", detectionID);
                        break;
                    case NONE:
                        detection.setType(detectionDTO.getType());
                        detection.setTime(Timestamp.from(Instant.now()));
                        log.info("Detection with ID: {} is not a malware", detectionID);
                        break;
                }
            } else if (detectionType.equals(DetectionType.NEW)) {
                detection = customMapper.dtoToEntity(detectionDTO);
                detection.setDevice(device);
                log.info("New detection with ID: {}", detectionID);
            } else {
                continue;
            }
            deviceRepository.save(device);
            detectionRepository.save(detection);
        }
    }

}
