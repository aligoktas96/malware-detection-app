package com.malwaredetection.app.unit;


import com.malwaredetection.app.controller.request.MalwareDetectionRequest;
import com.malwaredetection.app.controller.response.DetectionMessageResponse;
import com.malwaredetection.app.dto.DetectionDTO;
import com.malwaredetection.app.dto.DetectionSearchCriteria;
import com.malwaredetection.app.dto.DeviceDTO;
import com.malwaredetection.app.enums.DetectionType;
import com.malwaredetection.app.enums.DeviceType;
import com.malwaredetection.app.exception.BusinessException;
import com.malwaredetection.app.mapper.CustomMapper;
import com.malwaredetection.app.repository.DetectionRepository;
import com.malwaredetection.app.repository.DeviceRepository;
import com.malwaredetection.app.repository.entity.Detection;
import com.malwaredetection.app.repository.entity.Device;
import com.malwaredetection.app.service.DetectionService;
import com.malwaredetection.app.specification.MalwareDetectionSpecification;
import org.junit.jupiter.api.AfterEach;
import org.junit.jupiter.api.Assertions;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.Spy;
import org.mockito.junit.jupiter.MockitoExtension;
import org.springframework.data.domain.Sort;
import org.springframework.data.jpa.domain.Specification;

import java.util.ArrayList;
import java.util.List;
import java.util.UUID;

import static org.mockito.ArgumentMatchers.any;
import static org.mockito.Mockito.*;

@ExtendWith(MockitoExtension.class)
public class DetectionServiceTest {

    @InjectMocks
    private DetectionService detectionService;

    @Mock
    private DetectionRepository detectionRepository;

    @Mock
    private DeviceRepository deviceRepository;

    @Mock
    private CustomMapper customMapper;

    @Spy
    private MalwareDetectionSpecification malwareDetectionSpecification;

    Detection detection;

    Device device;

    MalwareDetectionRequest malwareDetectionRequest;

    @BeforeEach
    void setUp() {
        detection = Detection.builder().detectionID(UUID.randomUUID()).build();
        device = Device.builder().deviceUID(UUID.randomUUID()).build();

        malwareDetectionRequest = MalwareDetectionRequest.builder()
                .device(DeviceDTO.builder().deviceUID(UUID.randomUUID()).build())
                .detections(List.of(DetectionDTO.builder().detectionID(UUID.randomUUID()).type(DetectionType.RESOLVED).build()))
                .build();

        when(deviceRepository.findById(any(UUID.class))).thenReturn(java.util.Optional.of(device));
        when(detectionRepository.findById(any(UUID.class))).thenReturn(java.util.Optional.of(detection));
        when(customMapper.dtoToEntity(any(DetectionDTO.class))).thenReturn(detection);
        when(customMapper.dtoToEntity(any(DeviceDTO.class))).thenReturn(device);
        when(detectionRepository.save(any(Detection.class))).thenReturn(detection);

    }

    @Test
    public void shouldStoreDetectionForNewDetection() {

        detectionService.storeDetection(malwareDetectionRequest);

        verify(deviceRepository, times(1)).findById(any(UUID.class));
        verify(detectionRepository, times(1)).save(any(Detection.class));

    }

    @Test
    public void shouldStoreDetectionForResolvedDetection() {

        detectionService.storeDetection(malwareDetectionRequest);

        verify(deviceRepository, times(1)).findById(any(UUID.class));
        verify(detectionRepository, times(1)).save(any(Detection.class));
    }

    @Test
    public void shouldStoreDetectionForNoneDetection() {

        detectionService.storeDetection(malwareDetectionRequest);

        verify(deviceRepository, times(1)).findById(any(UUID.class));
        verify(detectionRepository, times(1)).save(any(Detection.class));
    }

    @Test
    public void shouldFindDetectionMessagesWithSpecifications() {

        when(detectionRepository.findAll(any(Specification.class), eq(Sort.by(Sort.Direction.DESC, "time")))).thenReturn(List.of(detection));
        when(customMapper.entityToMessageResponse(any(Detection.class))).thenReturn(DetectionMessageResponse.builder().build());
        DetectionSearchCriteria detectionSearchCriteria = DetectionSearchCriteria.builder()
                .deviceType(DeviceType.WEB)
                .nameOfApp("MyApp")
                .detectionType(DetectionType.NEW)
                .build();

        detectionService.findDetectionMessages(detectionSearchCriteria);

        verify(detectionRepository, times(1))
                .findAll(any(Specification.class), eq(Sort.by(Sort.Direction.DESC, "time")));

    }

    @Test
    public void shouldThrowBusinessExceptionForEmptyResult() {
        when(detectionRepository.findAll(any(Specification.class), eq(Sort.by(Sort.Direction.DESC, "time"))))
                .thenReturn(new ArrayList());

        Assertions.assertThrows(BusinessException.class, () ->
                detectionService.findDetectionMessages(DetectionSearchCriteria.builder().build()));
    }

    @AfterEach
    void tearDown() {
        device = null;
        detection = null;

        reset(detectionRepository);
        reset(deviceRepository);
        reset(customMapper);
    }
}
