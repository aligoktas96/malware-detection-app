package com.malwaredetection.app.unit;


import com.malwaredetection.app.builder.CustomMapper;
import com.malwaredetection.app.controller.dto.DetectionDTO;
import com.malwaredetection.app.controller.dto.DeviceDTO;
import com.malwaredetection.app.controller.request.MalwareDetectionRequest;
import com.malwaredetection.app.controller.response.DetectionMessageResponse;
import com.malwaredetection.app.enums.DetectionType;
import com.malwaredetection.app.enums.DeviceType;
import com.malwaredetection.app.repository.DetectionRepository;
import com.malwaredetection.app.repository.DeviceRepository;
import com.malwaredetection.app.repository.entity.Detection;
import com.malwaredetection.app.repository.entity.Device;
import com.malwaredetection.app.service.DetectionService;
import com.malwaredetection.app.util.Filtering;
import org.junit.jupiter.api.AfterEach;
import org.junit.jupiter.api.Assertions;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.params.ParameterizedTest;
import org.junit.jupiter.params.provider.ValueSource;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.springframework.boot.test.context.SpringBootTest;

import java.time.Instant;
import java.util.Date;
import java.util.List;
import java.util.UUID;

import static org.mockito.ArgumentMatchers.any;
import static org.mockito.Mockito.*;

@SpringBootTest
public class DetectionServiceTest {

    @InjectMocks
    private DetectionService detectionService;

    @Mock
    private DetectionRepository detectionRepository;

    @Mock
    private DeviceRepository deviceRepository;

    @Mock
    private CustomMapper customMapper;

    @Mock
    private Filtering filtering;

    Detection detection;

    Device device;

    MalwareDetectionRequest malwareDetectionRequest;

    @BeforeEach
    void setUp() {
        detection = Detection.builder().detectionID(UUID.randomUUID()).build();
        device = Device.builder().deviceUID(UUID.randomUUID()).build();

        malwareDetectionRequest = MalwareDetectionRequest.builder()
                .device(DeviceDTO.builder().deviceUID(UUID.randomUUID()).build())
                .detections(List.of(DetectionDTO.builder().detectionID(UUID.randomUUID()).type(DetectionType.RESOLVED).build()))
                .build();

        when(deviceRepository.findById(any(UUID.class))).thenReturn(java.util.Optional.of(device));
        when(detectionRepository.findById(any(UUID.class))).thenReturn(java.util.Optional.of(detection));
        when(customMapper.dtoToEntity(any(DetectionDTO.class))).thenReturn(detection);
        when(customMapper.dtoToEntity(any(DeviceDTO.class))).thenReturn(device);
        when(detectionRepository.save(any(Detection.class))).thenReturn(detection);

    }

    @Test
    public void shouldStoreDetectionForNewDetection() {

        detectionService.storeDetection(malwareDetectionRequest);

        verify(deviceRepository, times(1)).findById(any(UUID.class));
        verify(detectionRepository, times(1)).save(any(Detection.class));

    }

    @Test
    public void shouldStoreDetectionForResolvedDetection() {

        detectionService.storeDetection(malwareDetectionRequest);

        verify(deviceRepository, times(1)).findById(any(UUID.class));
        verify(detectionRepository, times(1)).save(any(Detection.class));
    }

    @Test
    public void shouldStoreDetectionForNoneDetection() {

        detectionService.storeDetection(malwareDetectionRequest);

        verify(deviceRepository, times(1)).findById(any(UUID.class));
        verify(detectionRepository, times(1)).save(any(Detection.class));
    }

    @ParameterizedTest
    @ValueSource(strings = {"NEW", "RESOLVED", "NONE"})
    public void shouldListAllDetections(DetectionType type) {
        //arrange
        when(detectionRepository.findByDeviceDeviceUIDOrderByTimeDesc(any(UUID.class))).thenReturn(List.of(new Detection()));
        when(filtering.filter(any(List.class), any(Instant.class), any(Instant.class), any(DeviceType.class), any(String.class), any(DetectionType.class)))
                .thenReturn(List.of(DetectionMessageResponse.builder().deviceUID(UUID.randomUUID()).type(type)
                        .nameOfApp("appName").deviceType(DeviceType.WEB).time(Date.from(Instant.now())).build()));

        //act
        List<DetectionMessageResponse> detections = detectionService.getDetectionsBySortedDate(
                UUID.randomUUID(), Instant.now(), Instant.now(), DeviceType.WEB, "appName", type);

        //assert
        verify(detectionRepository, times(1)).findByDeviceDeviceUIDOrderByTimeDesc(any(UUID.class));
        Assertions.assertEquals(1, detections.size());
        Assertions.assertEquals(type, detections.get(0).getType());
        Assertions.assertEquals("appName", detections.get(0).getNameOfApp());
        Assertions.assertEquals(DeviceType.WEB, detections.get(0).getDeviceType());
    }

    @AfterEach
    void tearDown() {
        device = null;
        detection = null;

        reset(detectionRepository);
        reset(deviceRepository);
        reset(customMapper);
    }
}
