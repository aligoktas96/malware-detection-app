package com.malwaredetection.app.service;

import com.malwaredetection.app.builder.CustomMapper;
import com.malwaredetection.app.controller.dto.DetectionDTO;
import com.malwaredetection.app.controller.dto.DeviceDTO;
import com.malwaredetection.app.controller.request.MalwareDetectionRequest;
import com.malwaredetection.app.controller.response.DetectionMessageResponse;
import com.malwaredetection.app.enums.DetectionType;
import com.malwaredetection.app.enums.DeviceType;
import com.malwaredetection.app.repository.DetectionRepository;
import com.malwaredetection.app.repository.DeviceRepository;
import com.malwaredetection.app.repository.entity.Detection;
import com.malwaredetection.app.repository.entity.Device;
import com.malwaredetection.app.util.Filtering;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.sql.Timestamp;
import java.time.Instant;
import java.util.List;
import java.util.Optional;
import java.util.UUID;

@Service
@RequiredArgsConstructor
public class DetectionService {

    private final DetectionRepository detectionRepository;

    private final DeviceRepository deviceRepository;

    private final Filtering filtering;

    private final CustomMapper customMapper;


    @Transactional
    public void storeDetection(MalwareDetectionRequest malwareDetectionRequest) {
        DeviceDTO deviceDTO = malwareDetectionRequest.getDevice();
        List<DetectionDTO> detections = malwareDetectionRequest.getDetections();

        Optional<Device> optionalDevice = deviceRepository.findById(deviceDTO.getDeviceUID());
        Device device = optionalDevice.orElseGet(() -> customMapper.dtoToEntity(deviceDTO));

        processDetections(detections, device);
    }

    public List<DetectionMessageResponse> getDetectionsBySortedDate(UUID deviceUID, Instant fromDate, Instant toDate, DeviceType deviceType, String nameOfApp, DetectionType detectionType) {

        List<Detection> messages = detectionRepository.findByDeviceDeviceUIDOrderByTimeDesc(deviceUID);

        return filtering.filter(messages, fromDate, toDate, deviceType, nameOfApp, detectionType);

    }

    private void processDetections(List<DetectionDTO> detections, Device device) {
        for (DetectionDTO detectionDTO : detections) {
            DetectionType detectionType = detectionDTO.getType();

            UUID detectionID = detectionDTO.getDetectionID();
            Optional<Detection> optionalDetection = detectionRepository.findById(detectionID);

            Detection detection;
            if (optionalDetection.isPresent()) {
                detection = optionalDetection.get();
                switch (detectionType) {
                    case RESOLVED:
                        detection.setResolvedDetectionID(detectionDTO.getResolvedDetectionID());
                        detection.setType(detectionDTO.getType());
                        detection.setTime(Timestamp.from(Instant.now()));
                        break;
                    case NONE:
                        detection.setType(detectionDTO.getType());
                        detection.setTime(Timestamp.from(Instant.now()));
                        break;
                }
            } else {
                if (detectionType.equals(DetectionType.NEW)) {
                    detection = customMapper.dtoToEntity(detectionDTO);
                    detection.setDevice(device);
                } else {
                    continue;
                }
            }
            deviceRepository.save(device);
            detectionRepository.save(detection);
        }
    }

}
